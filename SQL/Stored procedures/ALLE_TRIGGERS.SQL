USE Euratex
GO

CREATE TRIGGER TR_HISTORY_RISICOREGEL ON RISICOREGEL AFTER UPDATE,DELETE AS BEGIN
	SET NOCOUNT ON

	BEGIN TRY
		DECLARE @ACTIE VARCHAR(25) = (
			CASE
				WHEN EXISTS(SELECT * FROM INSERTED) AND EXISTS(SELECT * FROM DELETED)
					THEN 'UPDATE'
				WHEN EXISTS(SELECT * FROM DELETED)
					THEN 'DELETE'
				ELSE NULL
			END
		)

		INSERT INTO RISICOREGEL_HISTORY (
			PROJECTNUMMER
			,RAPPORTNUMMER
			,REGELNUMMER
			,ASPECTNAAM
			,EFFECTNAAM
			,ARBO_ONDERWERP
			,RISICO_OMSCHRIJVING_OF_BEVINDING
			,HUIDIGE_BEHEERSMAATREGEL
			,VOORGESTELDE_ACTIE_OF_VERBETERINGSMAATREGEL
			,VOOR_ERNST_VAN_ONGEVAL
			,VOOR_KANS_OP_BLOOTSTELLING
			,VOOR_KANS_OP_WAARSCHIJNLIJKHEID
			,AFWIJKENDE_ACTIE_TER_UITVOERING
			,RESTRISICO
			,NA_ERNST_VAN_ONGEVAL
			,NA_KANS_OP_BLOOTSTELLING
			,NA_KANS_OP_WAARSCHIJNLIJKHEID
			,VOOR_RISICO
			,VOOR_PRIORITEIT
			,NA_RISICO
			,NA_PRIORITEIT
			,ACTIE
		)
		SELECT *, @Actie
		FROM DELETED
	END TRY
	BEGIN CATCH
		IF @@TRANCOUNT > 0 BEGIN
			ROLLBACK TRANSACTION
		END;
		THROW
	END CATCH
END
GO

CREATE TRIGGER TR_VISUELE_BEOORDELING_HISTORY ON VISUELE_BEOORDELING AFTER UPDATE,DELETE AS BEGIN
	SET NOCOUNT ON

	BEGIN TRY
		DECLARE @ACTIE VARCHAR(25) = (
			CASE
				WHEN EXISTS(SELECT * FROM INSERTED) AND EXISTS(SELECT * FROM DELETED)
					THEN 'UPDATE'
				WHEN EXISTS(SELECT * FROM DELETED)
					THEN 'DELETE'
				ELSE NULL
			END
		)

		INSERT INTO VISUELE_BEOORDELING_HISTORY (
			PROJECTNUMMER
			,RAPPORTNUMMER
			,REGELNUMMER
			,PROCES
			,MACHINE_ONDERDEEL_
			,AFDELING
			,ACTIE
		)
		SELECT *,@Actie
		FROM DELETED
	END TRY
	BEGIN CATCH
		IF @@TRANCOUNT > 0 BEGIN
			ROLLBACK TRANSACTION
		END;
		THROW
	END CATCH
END
GO

CREATE TRIGGER TR_MACHINEVEILIGHEID_HISTORY ON MACHINEVEILIGHEID AFTER UPDATE, DELETE AS BEGIN
	SET NOCOUNT ON

	BEGIN TRY
		DECLARE @ACTIE VARCHAR(25) = (
			CASE
				WHEN EXISTS(SELECT * FROM INSERTED) AND EXISTS(SELECT * FROM DELETED)
					THEN 'UPDATE'
				WHEN EXISTS(SELECT * FROM DELETED)
					THEN 'DELETE'
				ELSE NULL
			END
		)

		INSERT INTO MACHINEVEILIGHEID_HISTORY (
			PROJECTNUMMER
			,RAPPORTNUMMER
			,REGELNUMMER
			,PID
			,LIJN
			,MACHINE_CODE
			,MACHINE
			,MODEL_TYPE
			,SERIENUMMER
			,LEVERANCIER
			,CE_MARKERING
			,CE_DOCUCHECK
			,AANVULLENDE_OMSCHRIJVING
			,TAKEN
			,TRANSPORT
			,MONTAGE
			,IN_BEDRIJFSNAME
			,TIJDENS_PRODUCTIE
			,TIJDENS_ONDERHOUD
			,TIJDENS_STORING
			,TIJDENS_REINIGEN
			,TIJDENS_AFSTELLEN
			,DEMONTAGE
			,ONTWERP
			,AFSCHERMING
			,INSTRUCTIE
			,FREQUENTIE
			,MOGELIJKHEID_OPTREDEN_GEVAARLIJKE_GEBEURTENIS
			,MOGELIJKHEID_VOORKOMEN_OF_BEPERKEN_SCHADE
			,CI
			,ERNST_VAN_DE_GEVOLGEN
			,ACTIE
		)
		SELECT *, @Actie
		FROM DELETED
	END TRY
	BEGIN CATCH
		IF @@TRANCOUNT > 0 BEGIN
			ROLLBACK TRANSACTION
		END;
		THROW
	END CATCH
END
GO

CREATE TRIGGER TR_PLAN_VAN_AANPAK_HISTORY ON PLAN_VAN_AANPAK AFTER UPDATE,DELETE AS BEGIN
	SET NOCOUNT ON

	BEGIN TRY
		DECLARE @ACTIE VARCHAR(25) = (
			CASE
				WHEN EXISTS(SELECT * FROM INSERTED) AND EXISTS(SELECT * FROM DELETED)
					THEN 'UPDATE'
				WHEN EXISTS(SELECT * FROM DELETED)
					THEN 'DELETE'
				ELSE NULL
			END
		)

		INSERT INTO PLAN_VAN_AANPAK_HISTORY (
			PROJECTNUMMER
			,RAPPORTNUMMER
			,REGELNUMMER
			,UITGEVOERD_DOOR
			,EINDVERANTWOORDELIJKE
			,DATUM_GEREED_GEPLAND
			,PBM
			,VOORLICHTING
			,WERKINSTRUCTIE_PROCEDURE
			,TRA
			,CONTRACT_LIJST_
			,ACTIE
		)
		SELECT *,@Actie
		FROM DELETED
	END TRY
	BEGIN CATCH
		IF @@TRANCOUNT > 0 BEGIN
			ROLLBACK TRANSACTION
		END;
		THROW
	END CATCH
END
GO

CREATE TRIGGER TR_PERIODIEKE_BEOORDELING_HISTORY ON PERIODIEKE_BEOORDELING AFTER UPDATE,DELETE AS BEGIN
	SET NOCOUNT ON

	BEGIN TRY
		DECLARE @ACTIE VARCHAR(25) = (
			CASE
				WHEN EXISTS(SELECT * FROM INSERTED) AND EXISTS(SELECT * FROM DELETED)
					THEN 'UPDATE'
				WHEN EXISTS(SELECT * FROM DELETED)
					THEN 'DELETE'
				ELSE NULL
			END
		)

		INSERT INTO PERIODIEKE_BEOORDELING_HISTORY (
			PROJECTNUMMER
			,RAPPORTNUMMER
			,REGELNUMMER
			,DATUM_BEOORDELING
			,INSPECTIE_IS_DE_ACTIE_UITGEVOERD
			,OPMERKING_STAND_VAN_ZAKEN
			,STAND_VAN_ZAKEN
			,SCORE
			,ACTIE
		)
		SELECT *,@Actie
		FROM DELETED
	END TRY
	BEGIN CATCH
		IF @@TRANCOUNT > 0 BEGIN
			ROLLBACK TRANSACTION
		END;
		THROW
	END CATCH
END
GO
